<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>數位名片管理系統 v2.0.5</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }
        
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        .card-image-container {
            aspect-ratio: 1.58 / 1;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 1rem;
        }
        
        .card-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes mobileSlideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        @media (max-width: 640px) {
            .mobile-bottom-sheet {
                animation: mobileSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
                border-radius: 1.5rem 1.5rem 0 0;
            }
        }

        .touch-active:active {
            transform: scale(0.96);
            opacity: 0.9;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .full-h-dynamic {
            height: 100dvh;
        }

        .debug-log {
            font-family: monospace;
            font-size: 10px;
            background: #0f172a;
            color: #22d3ee;
            padding: 8px;
            border-radius: 8px;
            max-height: 80px;
            overflow-y: auto;
            line-height: 1.4;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useRef, useMemo } = React;

        // --- 版本號 ---
        const APP_VERSION = "v2.0.5";

        // --- Firebase 初始化 ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyCmqmGIBfUv_UVJU80AB_iUpE_yLLX-dAw",
                authDomain: "mistake-notebook-caca8.firebaseapp.com",
                projectId: "mistake-notebook-caca8",
                storageBucket: "mistake-notebook-caca8.firebasestorage.app",
                messagingSenderId: "298098777699",
                appId: "1:298098777699:web:4590aecebc2293bab9e256",
                measurementId: "G-6S5QWYKT7M"
            };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : "business-card-app";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const Icon = ({ name, size = 20, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current) {
                    containerRef.current.innerHTML = '';
                    const icon = lucide.icons[name];
                    if (icon) {
                        const iconSvg = lucide.createElement(icon);
                        iconSvg.setAttribute('width', size);
                        iconSvg.setAttribute('height', size);
                        iconSvg.setAttribute('class', className);
                        containerRef.current.appendChild(iconSvg);
                    }
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center shrink-0" />;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [cards, setCards] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [isAdding, setIsAdding] = useState(false);
            const [editTarget, setEditTarget] = useState(null); // 用於儲存正在編輯的名片
            const [deleteTarget, setDeleteTarget] = useState(null);
            const [loading, setLoading] = useState(false);
            const [isConnecting, setIsConnecting] = useState(true);
            const [selectedImage, setSelectedImage] = useState(null);
            const [debugLogs, setDebugLogs] = useState([]);
            const [newCard, setNewCard] = useState({
                name: '', title: '', company: '', phone: '', email: ''
            });

            const addLog = (msg) => {
                setDebugLogs(prev => [...prev.slice(-10), `[${new Date().toLocaleTimeString()}] ${msg}`]);
            };

            // 1. 身份驗證邏輯
            useEffect(() => {
                const initAuth = async () => {
                    addLog("正在嘗試身份驗證...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        addLog(`驗證失敗，嘗試備用模式: ${e.code}`);
                        try {
                            await setPersistence(auth, inMemoryPersistence);
                            await signInAnonymously(auth);
                        } catch (fallbackErr) {
                            addLog("所有登入嘗試皆失敗。");
                        }
                    }
                };
                initAuth();

                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        addLog("驗證成功");
                        setUser(u);
                        setIsConnecting(false);
                    } else {
                        setUser(null);
                    }
                });
                return () => unsubscribe();
            }, []);

            // 2. 實時資料讀取
            useEffect(() => {
                if (!user) return;
                
                addLog("正在連接資料庫...");
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'cards');
                
                const unsubscribe = onSnapshot(colRef, 
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setCards(data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
                    },
                    (error) => {
                        addLog(`權限或讀取錯誤: ${error.code}`);
                        console.error("Firestore Error:", error);
                    }
                );
                return () => unsubscribe();
            }, [user]);

            const compressImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800;
                            let width = img.width;
                            let height = img.height;
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7));
                        };
                    };
                });
            };

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoading(true);
                const compressed = await compressImage(file);
                setSelectedImage(compressed);
                setLoading(false);
            };

            const saveCard = async () => {
                if (!user || !newCard.name) return;
                setLoading(true);
                try {
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'cards');
                    await addDoc(colRef, {
                        ...newCard,
                        imageUrl: selectedImage,
                        createdAt: new Date().toISOString(),
                        uid: user.uid
                    });
                    setIsAdding(false);
                    setNewCard({ name: '', title: '', company: '', phone: '', email: '' });
                    setSelectedImage(null);
                } catch (e) {
                    addLog(`儲存失敗: ${e.code}`);
                } finally {
                    setLoading(false);
                }
            };

            // 更新名片文字資料
            const handleUpdateCard = async () => {
                if (!user || !editTarget || !editTarget.name) return;
                setLoading(true);
                try {
                    const cardDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'cards', editTarget.id);
                    await updateDoc(cardDocRef, {
                        name: editTarget.name,
                        title: editTarget.title,
                        company: editTarget.company,
                        phone: editTarget.phone,
                        email: editTarget.email,
                        updatedAt: new Date().toISOString()
                    });
                    setEditTarget(null);
                } catch (e) {
                    addLog(`更新失敗: ${e.code}`);
                } finally {
                    setLoading(false);
                }
            };

            const filteredCards = useMemo(() => {
                return cards.filter(c => 
                    (c.name || '').toLowerCase().includes(searchTerm.toLowerCase()) || 
                    (c.company || '').toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [cards, searchTerm]);

            if (isConnecting) {
                return (
                    <div className="flex flex-col items-center justify-center full-h-dynamic bg-white p-6 text-center">
                        <Icon name="Loader2" className="animate-spin text-indigo-600 mb-4" size={48} />
                        <p className="text-slate-400 font-bold tracking-widest text-xs uppercase">雲端驗證中... ({APP_VERSION})</p>
                        <div className="mt-8 w-full max-w-xs debug-log text-left">
                            {debugLogs.map((l, i) => <div key={i}>{l}</div>)}
                        </div>
                    </div>
                );
            }

            return (
                <div className="full-h-dynamic flex flex-col max-w-4xl mx-auto bg-slate-50">
                    {/* Header */}
                    <header className="p-5 pb-2 flex justify-between items-center bg-slate-50/80 backdrop-blur-md sticky top-0 z-30">
                        <div>
                            <div className="flex items-center gap-2">
                                <h1 className="text-2xl font-black text-slate-800 tracking-tighter">名片管理</h1>
                                <span className="bg-indigo-100 text-indigo-600 text-[10px] font-bold px-2 py-0.5 rounded-full">{APP_VERSION}</span>
                            </div>
                            <div className="flex items-center gap-1.5 mt-0.5">
                                <span className="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">已安全連線</span>
                            </div>
                        </div>
                        <button 
                            onClick={() => setIsAdding(true)}
                            className="touch-active bg-indigo-600 text-white p-3 rounded-2xl shadow-lg shadow-indigo-200"
                        >
                            <Icon name="Plus" size={24} />
                        </button>
                    </header>

                    {/* Search */}
                    <div className="px-5 py-3">
                        <div className="relative">
                            <Icon name="Search" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                            <input 
                                type="text"
                                placeholder="搜尋姓名、公司..."
                                className="w-full bg-white border-none rounded-2xl py-3.5 pl-12 pr-4 shadow-sm focus:ring-2 focus:ring-indigo-500 transition-all text-base"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                    </div>

                    {/* Card List */}
                    <main className="flex-1 overflow-y-auto px-5 pb-10 hide-scrollbar">
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            {filteredCards.map(card => (
                                <div key={card.id} className="bg-white rounded-[2rem] p-4 shadow-sm border border-slate-100 relative overflow-hidden">
                                    <div className="card-image-container mb-4">
                                        {card.imageUrl ? (
                                            <img src={card.imageUrl} alt="Card" />
                                        ) : (
                                            <Icon name="Image" size={32} className="text-slate-200" />
                                        )}
                                    </div>
                                    <div className="space-y-1">
                                        <div className="flex justify-between items-start">
                                            <h3 className="font-bold text-lg text-slate-800 truncate">{card.name}</h3>
                                            <div className="flex items-center gap-2">
                                                <button 
                                                    onClick={() => setEditTarget(card)}
                                                    className="text-slate-300 hover:text-indigo-500 p-1"
                                                >
                                                    <Icon name="Pencil" size={18} />
                                                </button>
                                                <button 
                                                    onClick={() => setDeleteTarget(card)}
                                                    className="text-slate-300 hover:text-red-500 p-1"
                                                >
                                                    <Icon name="Trash2" size={18} />
                                                </button>
                                            </div>
                                        </div>
                                        <p className="text-indigo-600 text-xs font-black uppercase tracking-wider">{card.title || '無職稱'}</p>
                                        <div className="pt-2 space-y-1.5">
                                            <div className="flex items-center gap-2 text-xs text-slate-500 font-medium">
                                                <Icon name="Building" size={14} className="text-slate-400 shrink-0" />
                                                <span className="truncate">{card.company || '-'}</span>
                                            </div>
                                            <div className="flex items-center gap-2 text-xs text-slate-500 font-medium">
                                                <Icon name="Phone" size={14} className="text-slate-400 shrink-0" />
                                                <span>{card.phone || '-'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        {filteredCards.length === 0 && (
                            <div className="flex flex-col items-center justify-center py-20 opacity-20">
                                <Icon name="Inbox" size={64} />
                                <p className="font-bold mt-4">尚無名片資料</p>
                            </div>
                        )}
                    </main>

                    {/* 新增名片 Modal */}
                    {isAdding && (
                        <div className="fixed inset-0 z-50 flex flex-col justify-end sm:justify-center sm:items-center bg-slate-900/60 backdrop-blur-sm">
                            <div className="absolute inset-0" onClick={() => setIsAdding(false)}></div>
                            <div className="mobile-bottom-sheet bg-white w-full sm:max-w-xl sm:rounded-[2.5rem] max-h-[92dvh] overflow-hidden flex flex-col relative">
                                <div className="p-6 border-b border-slate-50 flex justify-between items-center shrink-0">
                                    <h2 className="text-xl font-black">新增名片</h2>
                                    <button onClick={() => setIsAdding(false)} className="p-2 bg-slate-100 rounded-full text-slate-500">
                                        <Icon name="X" size={20} />
                                    </button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-6 space-y-6 hide-scrollbar">
                                    <div className="relative card-image-container border-2 border-dashed border-slate-200 bg-slate-50 cursor-pointer overflow-hidden active:bg-slate-100 transition-colors">
                                        {selectedImage ? (
                                            <img src={selectedImage} />
                                        ) : (
                                            <div className="flex flex-col items-center gap-2 text-slate-400">
                                                <Icon name="Camera" size={40} />
                                                <p className="text-xs font-bold uppercase tracking-widest">拍名片或選取檔案</p>
                                            </div>
                                        )}
                                        <input 
                                            type="file" 
                                            accept="image/*"
                                            className="absolute inset-0 opacity-0 cursor-pointer"
                                            onChange={handleFileChange}
                                        />
                                        {loading && (
                                            <div className="absolute inset-0 bg-white/80 flex items-center justify-center">
                                                <Icon name="Loader2" className="animate-spin text-indigo-600" size={32} />
                                            </div>
                                        )}
                                    </div>

                                    <div className="space-y-4 pb-10">
                                        {[
                                            { label: '姓名 (必填)', key: 'name' },
                                            { label: '職稱', key: 'title' },
                                            { label: '公司', key: 'company' },
                                            { label: '電話', key: 'phone' },
                                            { label: 'Email', key: 'email' }
                                        ].map(field => (
                                            <div key={field.key}>
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-1 block">
                                                    {field.label}
                                                </label>
                                                <input 
                                                    type="text"
                                                    value={newCard[field.key]}
                                                    onChange={e => setNewCard({...newCard, [field.key]: e.target.value})}
                                                    className="w-full bg-slate-50 border-none rounded-2xl p-4 text-base font-bold focus:ring-2 focus:ring-indigo-500 transition-all shadow-inner"
                                                    placeholder={`輸入${field.label.split(' ')[0]}`}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="p-6 pt-2 border-t border-slate-50 shrink-0 mb-safe">
                                    <button 
                                        disabled={!newCard.name || loading}
                                        onClick={saveCard}
                                        className="touch-active w-full bg-indigo-600 text-white py-4 rounded-[1.5rem] font-black shadow-xl shadow-indigo-100 disabled:opacity-30 disabled:shadow-none flex items-center justify-center gap-2"
                                    >
                                        {loading ? <Icon name="Loader2" className="animate-spin" size={20} /> : <Icon name="CheckCircle" size={20} />}
                                        確認儲存
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 修改名片 Modal */}
                    {editTarget && (
                        <div className="fixed inset-0 z-50 flex flex-col justify-end sm:justify-center sm:items-center bg-slate-900/60 backdrop-blur-sm">
                            <div className="absolute inset-0" onClick={() => setEditTarget(null)}></div>
                            <div className="mobile-bottom-sheet bg-white w-full sm:max-w-xl sm:rounded-[2.5rem] max-h-[92dvh] overflow-hidden flex flex-col relative shadow-2xl">
                                <div className="p-6 border-b border-slate-50 flex justify-between items-center shrink-0">
                                    <h2 className="text-xl font-black">修改資訊</h2>
                                    <button onClick={() => setEditTarget(null)} className="p-2 bg-slate-100 rounded-full text-slate-500">
                                        <Icon name="X" size={20} />
                                    </button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-6 space-y-6 hide-scrollbar">
                                    {/* 預覽目前的圖片 (不支援修改圖片以保持穩定性) */}
                                    <div className="card-image-container border-2 border-slate-100 bg-slate-50 grayscale-[0.5] opacity-80">
                                        {editTarget.imageUrl ? (
                                            <img src={editTarget.imageUrl} alt="Current Card" />
                                        ) : (
                                            <Icon name="Image" size={32} className="text-slate-200" />
                                        )}
                                    </div>

                                    <div className="space-y-4 pb-10">
                                        {[
                                            { label: '姓名 (必填)', key: 'name' },
                                            { label: '職稱', key: 'title' },
                                            { label: '公司', key: 'company' },
                                            { label: '電話', key: 'phone' },
                                            { label: 'Email', key: 'email' }
                                        ].map(field => (
                                            <div key={field.key}>
                                                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-1 block">
                                                    {field.label}
                                                </label>
                                                <input 
                                                    type="text"
                                                    value={editTarget[field.key] || ''}
                                                    onChange={e => setEditTarget({...editTarget, [field.key]: e.target.value})}
                                                    className="w-full bg-slate-50 border-none rounded-2xl p-4 text-base font-bold focus:ring-2 focus:ring-indigo-500 transition-all shadow-inner"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="p-6 pt-2 border-t border-slate-50 shrink-0 mb-safe">
                                    <button 
                                        disabled={!editTarget.name || loading}
                                        onClick={handleUpdateCard}
                                        className="touch-active w-full bg-indigo-600 text-white py-4 rounded-[1.5rem] font-black shadow-xl shadow-indigo-100 disabled:opacity-30 disabled:shadow-none flex items-center justify-center gap-2"
                                    >
                                        {loading ? <Icon name="Loader2" className="animate-spin" size={20} /> : <Icon name="Save" size={20} />}
                                        儲存修改
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 刪除確認 Modal */}
                    {deleteTarget && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-slate-900/60 backdrop-blur-sm">
                            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-xs text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icon name="Trash2" size={32} />
                                </div>
                                <h3 className="text-xl font-black mb-2">確定刪除？</h3>
                                <p className="text-sm text-slate-500 mb-8 leading-relaxed">「{deleteTarget.name}」的資料將從雲端庫移除。</p>
                                <div className="space-y-3">
                                    <button 
                                        onClick={async () => {
                                            try {
                                                const cardDoc = doc(db, 'artifacts', appId, 'public', 'data', 'cards', deleteTarget.id);
                                                await deleteDoc(cardDoc);
                                                setDeleteTarget(null);
                                            } catch (e) {
                                                addLog(`刪除失敗: ${e.code}`);
                                            }
                                        }}
                                        className="touch-active w-full bg-red-500 text-white py-4 rounded-2xl font-black shadow-lg shadow-red-100"
                                    >
                                        確定刪除
                                    </button>
                                    <button onClick={() => setDeleteTarget(null)} className="w-full text-slate-400 font-bold py-2 hover:text-slate-600 transition-colors">取消</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>